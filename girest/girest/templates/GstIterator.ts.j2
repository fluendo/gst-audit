{# GstIterator template - handles GstIterator with AsyncIterable interface #}
export class {{ name }}{% if parent_class %} extends {{ parent_class }}{% endif %} implements AsyncIterable<GObjectObject> {
{% if has_destructor %}
  ptr!: string;
  
  constructor(ptr?: string) {
    if (ptr) {
      this.ptr = ptr;
      {{ destructor_registry }}.register(this, ptr);
    }
  }
  
  // Manual cleanup method
  {{ destructor_method_name }}(): Promise<void> {
    if (!this.ptr) return Promise.resolve();
    {{ destructor_registry }}.unregister(this);
    const url = new URL(`${apiConfig.normalizedBasePath}{{ destructor_path }}`, apiConfig.baseUrl);
    return fetch(url.toString())
      .then(response => {
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      });
  }
{% else %}
{% for prop in properties %}
  {{ prop.name }}{{ prop.assertion }}: {{ prop.type }};
{% endfor %}
{% endif %}

  // Implement AsyncIterable interface
  [Symbol.asyncIterator](): AsyncIterator<GObjectObject, any, any> {
    let value: GObjectValue | null = null;
    
    return {
      next: async (): Promise<IteratorResult<GObjectObject>> => {
        // Initialize value lazily on first call
        if (!value) {
          value = await GObjectValue.new();
        }
        
        while (true) {
          await value.unset();
          const res = await this.next(value);
          
          switch (res) {
            case GstIteratorResult.DONE:
              return { done: true, value: undefined };
              
            case GstIteratorResult.OK:
              // Get the current value and return it
              const obj = await value.get_object();
              return { done: false, value: obj };
              
            case GstIteratorResult.RESYNC:
              // Iterator was modified, resync and continue
              await this.resync();
              break;
              
            case GstIteratorResult.ERROR:
              throw new Error('Iterator error');
          }
        }
      }
    };
  }
{% if properties and (constructors or methods) %}

{% endif %}
{{ constructors | join('\n') }}
{% if constructors and methods %}

{% endif %}
{{ methods | join('\n') }}
}
